- name: Query OMDb API and create Excel
  hosts: ditra
  gather_facts: false
  vars_files:
    - vars/secrets.yml
  vars:
    search_term: "Matrix"
    output_file: "movies_results.xlsx"
    log_file: "ansible_api_excel.log"
    ts: "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%SZ') }}"

  tasks:
    - name: Check Host Connectivity
      block:
        - name: Check host connectivity
          ansible.builtin.wait_for_connection:
            timeout: 10
          register: connectivity_check

        - name: Log Host Reachable
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][SUCCESS] Host {{ inventory_hostname }} is reachable"
          delegate_to: localhost
          create: yes
          changed_when: false

        - name: Log Host Unreachable
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][WARNING] Host {{ inventory_hostname }} is unreachable, continuing with API process"
          delegate_to: localhost
          create: yes
          changed_when: false

        - name: Log Success
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][INFO] Host {{ inventory_hostname }} - Success: {{ search_term }} -> {{ output_file }}"
          delegate_to: localhost
          create: yes
          changed_when: false
          when: host_is_reachable | default(false)

        - name: Log Failure
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][ERROR] Host {{ inventory_hostname }} - {{ ansible_failed_task.name }}: {{ ansible_failed_result.msg | default('Execution failed') }}"
          delegate_to: localhost
          create: yes
          changed_when: false

        - name: Set connectivity flag
          ansible.builtin.set_fact:
            host_is_reachable: true

      rescue:
        - name: Log Host Unreachable
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][WARNING] Host {{ inventory_hostname }} is unreachable, continuing with API process"
          delegate_to: localhost
          create: yes
          changed_when: false

        - name: Set connectivity flag
          ansible.builtin.set_fact:
            host_is_reachable: false

    - name: API Process
      block:
        - name: Query OMDb API
          ansible.builtin.uri:
            url: "http://www.omdbapi.com/?apikey={{ omdb_api_key }}&s={{ search_term }}"
            return_content: true
          register: api_res
          delegate_to: localhost

        - name: Validate API Response
          ansible.builtin.assert:
            that:
              - api_res.json.Response == "True"
            fail_msg: "API Error: {{ api_res.json.Error | default('Unknown') }}"

        - name: Debug API Response
          ansible.builtin.debug:
            msg:
              - "API Status: {{ api_res.status }}"
              - "Response: {{ api_res.json.Response }}"
              - "Total Results: {{ api_res.json.totalResults | default('N/A') }}"
              - "Search Term: {{ search_term }}"
              - "Results Found: {{ api_res.json.Search | length if api_res.json.Response == 'True' else 0 }}"
          delegate_to: localhost
          when: not (host_is_reachable | default(false))

        - name: Create Excel
          ditra.cisco.one_sheet_excel:
            create: true
            data: "{{ api_res.json.Search }}"
            file: "{{ output_file }}"
            operation: write
            path: "."
            sheet_name: "movies"
          delegate_to: localhost
          register: excel_done

        - name: Debug
          ansible.builtin.debug:
            var: excel_done

        - name: Send notification
          ditra.cisco.send_email:
            smtp_server: "{{ smtp_server }}"
            smtp_port: "{{ smtp_port }}"
            smtp_username: "{{ smtp_username }}"
            smtp_password: "{{ smtp_password }}"
            use_tls: true
            from_email: "{{ from_email }}"
            to_emails:
              - "adrian.ortiz@ditra.mx"
            subject: "Reporte"
            body: "Texto plano en body"
            html_body: "{{ lookup('file', 'templates/reporte.html') }}"
          when: not excel_done.failed

        - name: Remove temp file
          ansible.builtin.file:
            path: "/tmp/api_data.json"
            state: absent
          delegate_to: localhost
          when: host_is_reachable | default(false)

        - name: Log Success
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][INFO] Host {{ inventory_hostname }} - Success: {{ search_term }} -> {{ output_file }}"
          delegate_to: localhost
          create: yes
          changed_when: false
          when: host_is_reachable | default(false)

      rescue:
        - name: Log Failure
          ansible.builtin.lineinfile:
            path: "{{ log_file }}"
            line: "[{{ ts }}][ERROR] Host {{ inventory_hostname }} - {{ ansible_failed_task.name }}: {{ ansible_failed_result.msg | default('Execution failed') }}"
          delegate_to: localhost
          create: yes
          changed_when: false
